# Copyright 2024 3WEBS LLC
# SPDX-License-Identifier: GPL-3.0-or-later

name: Continuous Integration

on:
    push:
        branches:
          - main
    pull_request:
        branches:
          - main

jobs:
    codeql:
        name: ğŸ§ª CodeQL
        runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
        timeout-minutes: ${{ (matrix.language == 'swift' && 120) || 360 }}
        permissions:
            security-events: write
            actions: read
            contents: read
        strategy:
            fail-fast: false
            matrix:
                language:
                  - c-cpp
                  - csharp
                  - go
                  - java-kotlin
                  - javascript-typescript
                  - python
                  - ruby
                  - swift
        steps:
          - name: ğŸ“¦ Checkout Repository
            uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
            with:
                fetch-depth: 2
          - name: ğŸ§ª Initialize CodeQL
            uses: github/codeql-action/init@v3
            with:
              languages: ${{ matrix.language }}
          - name: ğŸ—ï¸ Autobuild
            uses: github/codeql-action/autobuild@v3
          - name: ğŸ§ª Perform CodeQL Analysis
            uses: github/codeql-action/analyze@v3
            with:
                category: "/language:${{matrix.language}}"
    markdownlint:
        name: ğŸ–‹ï¸ Markdownlint
        runs-on: ubuntu-latest
        steps:
          - name: ğŸ“¦ Checkout Repository
            uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
            with:
                fetch-depth: 2
          - name: ğŸŸ° Detect Changed Files
            uses: tj-actions/changed-files@aa08304bd477b800d468db44fe10f6c61f7f7b11 # v42.1.0
            id: changed-files
            with:
              files: '**/*.md'
              separator: ","
          - name: ğŸ–‹ï¸ Markdownlint
            uses: DavidAnson/markdownlint-cli2-action@510b996878fc0d1a46c8a04ec86b06dbfba09de7  # v15.0.0
            with:
                config: .markdownlint.yml
                globs: ${{ steps.changed-files.outputs.all_changed_files }}
                separator: ","
    reuse:
        name: ğŸ“ REUSE
        runs-on: ubuntu-latest
        steps:
          - name: ğŸ“¦ Checkout Repository
            uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
            with:
                fetch-depth: 2
          - name: ğŸŸ° Detect Changed Files
            uses: tj-actions/changed-files@aa08304bd477b800d468db44fe10f6c61f7f7b11 # v42.1.0
            id: changed-files
            with:
              files: '**/*'
              separator: "|"
          - name: ğŸ—‘ï¸ Delete Unchanged Files
            run: |
              shopt -s extglob
              rm -rf !(${{ steps.changed-files.outputs.all_changed_files }}|.reuse|LICENSES)
          - name: ğŸ“ REUSE Compliance Check
            uses: fsfe/reuse-action@a46482ca367aef4454a87620aa37c2be4b2f8106  # v3.0.0
